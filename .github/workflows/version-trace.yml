name: Version Trace

on:
  push:
    branches:
      - main
      - bot-stable
      - bot-beta
  workflow_dispatch:

permissions:
  contents: write

jobs:
  tag-iteration:
    runs-on: ubuntu-latest
    steps:
      - name: Create trace tag
        env:
          GITHUB_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          BRANCH: ${{ github.ref_name }}
        run: |
          set -e
          ts=$(date -u +"%Y%m%d-%H%M%S")
          sha=$(printf "%s" "$SHA" | cut -c1-7)
          branch=${BRANCH//\//-}
          tag="trace-${branch}-${ts}-${sha}"
          api="https://api.github.com/repos/${REPO}/git/refs"

          payload=$(printf '{"ref":"refs/tags/%s","sha":"%s"}' "$tag" "$SHA")
          code=$(curl -sS -o /tmp/tag_create_resp.json -w "%{http_code}" \
            -X POST "$api" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -d "$payload")
          if [ "$code" -lt 200 ] || [ "$code" -ge 300 ]; then
            echo "failed to create tag, http=${code}"
            cat /tmp/tag_create_resp.json
            exit 1
          fi

          echo "created tag: $tag"
